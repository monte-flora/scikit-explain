<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feature Contributions Documentation &mdash; Scikit-Explain latest documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SHAP" href="../shap.html" />
    <link rel="prev" title="Feature Attributions (SHAP, LIME, and TreeInterpreter)" href="../feature_attributions.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #343131" >
            <a href="../index.html" class="icon icon-home"> Scikit-Explain
          </a>
              <div class="version">
                latest
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../explain_toolkit.html">ExplainToolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ale.html">Accumulated Local Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pd.html">Partial Dependence</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../feature_attributions.html">Feature Attributions</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Feature Contributions Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Loading-the-training-data-and-pre-fit-models">Loading the training data and pre-fit models</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Tree-Interpreter-Based-Feature-Contribution-(Single-Example)">Tree Interpreter-Based Feature Contribution (Single Example)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Tree-Interpreter-Based-Feature-Contribution-(Performance-Based)">Tree Interpreter-Based Feature Contribution (Performance-Based)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#SHAP-based-Feature-Contributions-(Single-Example)">SHAP-based Feature Contributions (Single Example)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#SHAP-based-Feature-Contributions-(Performance-based)">SHAP-based Feature Contributions (Performance-based)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#LIME-based-Feature-Contributions">LIME-based Feature Contributions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Feature-Contributions-for-Regression-Problems">Feature Contributions for Regression Problems</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../shap.html">SHAP-Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pimp.html">Permutation Importance</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #343131" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Scikit-Explain</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../feature_attributions.html">Feature Attributions (SHAP, LIME, and TreeInterpreter)</a> &raquo;</li>
      <li>Feature Contributions Documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/feature_contributions.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Feature-Contributions-Documentation">
<h1>Feature Contributions Documentation<a class="headerlink" href="#Feature-Contributions-Documentation" title="Permalink to this headline"></a></h1>
<p>This notebook is designed to demonstrate how to use <code class="docutils literal notranslate"><span class="pre">skexplain</span></code> to compute feature contributions using <a class="reference external" href="https://github.com/slundberg/shap">SHAP</a> or <a class="reference external" href="https://github.com/andosa/treeinterpreter">treeinterpreter</a> and plot the results. For more information on dataset and initializing <code class="docutils literal notranslate"><span class="pre">ExplainToolkit</span></code>, see the permutatation importance notebook. In this set of examples, we will demostrate using feature contributions for a single example and summarize a set of examples by model performance.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">current_dir</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">skexplain</span>
<span class="kn">import</span> <span class="nn">plotting_config</span>
<span class="kn">import</span> <span class="nn">shap</span>
<span class="kn">from</span> <span class="nn">skexplain.common.contrib_utils</span> <span class="kn">import</span> <span class="n">get_indices_based_on_performance</span><span class="p">,</span> <span class="n">avg_and_sort_contributions</span>
</pre></div>
</div>
</div>
<section id="Loading-the-training-data-and-pre-fit-models">
<h2>Loading the training data and pre-fit models<a class="headerlink" href="#Loading-the-training-data-and-pre-fit-models" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">estimators</span> <span class="o">=</span> <span class="n">skexplain</span><span class="o">.</span><span class="n">load_models</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">skexplain</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Tree-Interpreter-Based-Feature-Contribution-(Single-Example)">
<h2>Tree Interpreter-Based Feature Contribution (Single Example)<a class="headerlink" href="#Tree-Interpreter-Based-Feature-Contribution-(Single-Example)" title="Permalink to this headline"></a></h2>
<p>For decision trees models trained from the scikit-learn package, we can calculate feature contributions using the treeinterpreter method. The idea is that starting from the climatological event frequency of a dataset (AKA the “bias”, 39% in our case), each split made in the decision path adds to or substracts from the bias to produce the final prediction. For an ensemble method like random forests, we can compute the contributions per tree and then take the ensemble average contribution. In our
first example, we can get the contribution break-down for a single example for the random forest model (tree interpreter doesn’t work for gradient-boosted models).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">single_example</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">100</span><span class="p">]]</span>

<span class="n">explainer</span> <span class="o">=</span> <span class="n">skexplain</span><span class="o">.</span><span class="n">ExplainToolkit</span><span class="p">(</span><span class="n">estimators</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">X</span><span class="o">=</span><span class="n">single_example</span><span class="p">,</span>
                                   <span class="p">)</span>

<span class="n">contrib_ds</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">local_contributions</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;tree_interpreter&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">plot_contributions</span><span class="p">(</span>
    <span class="n">contrib</span> <span class="o">=</span> <span class="n">contrib_ds</span><span class="p">,</span>
    <span class="n">display_feature_names</span><span class="o">=</span><span class="n">plotting_config</span><span class="o">.</span><span class="n">display_feature_names</span><span class="p">,</span>
    <span class="n">display_units</span> <span class="o">=</span> <span class="n">plotting_config</span><span class="o">.</span><span class="n">display_units</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_feature_contributions_7_0.png" src="../_images/notebooks_feature_contributions_7_0.png" />
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Prediction</span></code> is the final prediction for this example while <code class="docutils literal notranslate"><span class="pre">Bias</span></code> is the bias. The idea is that the summation of the contributions plus the bias will equal the final prediction. For this particular example, there are competing effects.</p>
<section id="Tree-Interpreter-Based-Feature-Contribution-(Performance-Based)">
<h3>Tree Interpreter-Based Feature Contribution (Performance-Based)<a class="headerlink" href="#Tree-Interpreter-Based-Feature-Contribution-(Performance-Based)" title="Permalink to this headline"></a></h3>
<p>Although it can be important to assess the breakdown of a single prediction, we can also summarize feature contributions over several examples. By setting <code class="docutils literal notranslate"><span class="pre">performance_based=True</span></code>, we can summarize feature contributions for the top and worst performers. The number of examples to compute these summarized statistics is given by <code class="docutils literal notranslate"><span class="pre">n_examples</span></code>. In this case, we want to summarize the contributions over top 100 best and worst performing examples.</p>
<p><strong>Note</strong>: “Hits” and “Misses” are defined as a set of predictions being close to or far from the target variables (binary or regression), respectively, and “Correct Negatives (Corr Negs)” and “False Alarms” are defined as a set of predictions being close to or far from the target variable.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">perf_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Best Hits&quot;</span><span class="p">,</span>
             <span class="s2">&quot;Worst False Alarms&quot;</span><span class="p">,</span>
             <span class="s2">&quot;Worst Misses&quot;</span><span class="p">,</span>
            <span class="p">]</span>
<span class="n">explainer</span> <span class="o">=</span> <span class="n">skexplain</span><span class="o">.</span><span class="n">ExplainToolkit</span><span class="p">(</span><span class="n">estimators</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,)</span>
<span class="n">tree_results</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">local_contributions</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;tree_interpreter&#39;</span><span class="p">,</span>
                                           <span class="n">performance_based</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">n_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">tree_results</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>dllwave_flux_contrib</th>
      <th>dwpt2m_contrib</th>
      <th>fric_vel_contrib</th>
      <th>gflux_contrib</th>
      <th>high_cloud_contrib</th>
      <th>lat_hf_contrib</th>
      <th>low_cloud_contrib</th>
      <th>mid_cloud_contrib</th>
      <th>sat_irbt_contrib</th>
      <th>sens_hf_contrib</th>
      <th>...</th>
      <th>vbd_flux_val</th>
      <th>vdd_flux_val</th>
      <th>wind10m_val</th>
      <th>date_marker_val</th>
      <th>urban_val</th>
      <th>rural_val</th>
      <th>d_ground_val</th>
      <th>d_rad_d_val</th>
      <th>d_rad_u_val</th>
      <th>hrrr_dT_val</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Best Hits</th>
      <th>Random Forest</th>
      <td>0.687594</td>
      <td>2.951862</td>
      <td>0.050928</td>
      <td>0.162824</td>
      <td>0.010325</td>
      <td>0.387316</td>
      <td>0.043668</td>
      <td>0.020297</td>
      <td>1.677154</td>
      <td>0.378342</td>
      <td>...</td>
      <td>10.0000</td>
      <td>10.0000</td>
      <td>5.4324</td>
      <td>27.4</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>54.4</td>
      <td>-202.55</td>
      <td>-260.09</td>
      <td>3.211255</td>
    </tr>
    <tr>
      <th>Worst Misses</th>
      <th>Random Forest</th>
      <td>0.322094</td>
      <td>-1.424507</td>
      <td>0.779787</td>
      <td>1.171240</td>
      <td>0.060635</td>
      <td>0.349905</td>
      <td>0.309327</td>
      <td>0.056986</td>
      <td>0.160149</td>
      <td>0.157170</td>
      <td>...</td>
      <td>43.1990</td>
      <td>43.1990</td>
      <td>5.0382</td>
      <td>54.1</td>
      <td>0.3</td>
      <td>0.7</td>
      <td>49.1</td>
      <td>-269.98</td>
      <td>-306.54</td>
      <td>0.115133</td>
    </tr>
    <tr>
      <th>Worst False Alarms</th>
      <th>Random Forest</th>
      <td>-0.139319</td>
      <td>2.477546</td>
      <td>-0.452114</td>
      <td>-0.385906</td>
      <td>-0.138718</td>
      <td>-0.262534</td>
      <td>-0.174772</td>
      <td>-0.257304</td>
      <td>1.177671</td>
      <td>-0.277776</td>
      <td>...</td>
      <td>13.4750</td>
      <td>13.4750</td>
      <td>4.3595</td>
      <td>31.7</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>59.3</td>
      <td>-202.69</td>
      <td>-263.71</td>
      <td>2.296170</td>
    </tr>
    <tr>
      <th>Best Corr. Negatives</th>
      <th>Random Forest</th>
      <td>-0.246537</td>
      <td>-2.095581</td>
      <td>-0.048274</td>
      <td>-0.059791</td>
      <td>0.002933</td>
      <td>-0.080915</td>
      <td>-0.009961</td>
      <td>-0.024212</td>
      <td>-0.199135</td>
      <td>-0.266709</td>
      <td>...</td>
      <td>51.1225</td>
      <td>51.1225</td>
      <td>2.9579</td>
      <td>51.3</td>
      <td>0.3</td>
      <td>0.7</td>
      <td>-40.2</td>
      <td>-173.51</td>
      <td>-201.66</td>
      <td>-0.944900</td>
    </tr>
  </tbody>
</table>
<p>4 rows × 61 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_results</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MultiIndex([(           &#39;Best Hits&#39;, &#39;Random Forest&#39;),
            (        &#39;Worst Misses&#39;, &#39;Random Forest&#39;),
            (  &#39;Worst False Alarms&#39;, &#39;Random Forest&#39;),
            (&#39;Best Corr. Negatives&#39;, &#39;Random Forest&#39;)],
           )
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">plot_contributions</span><span class="p">(</span>
    <span class="n">contrib</span> <span class="o">=</span> <span class="n">tree_results</span><span class="p">,</span>
    <span class="n">display_feature_names</span><span class="o">=</span><span class="n">plotting_config</span><span class="o">.</span><span class="n">display_feature_names</span><span class="p">,</span>
    <span class="n">display_units</span> <span class="o">=</span> <span class="n">plotting_config</span><span class="o">.</span><span class="n">display_units</span><span class="p">,</span>
    <span class="n">perf_keys</span><span class="o">=</span><span class="n">perf_keys</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_feature_contributions_12_0.png" src="../_images/notebooks_feature_contributions_12_0.png" />
</div>
</div>
</section>
</section>
<section id="SHAP-based-Feature-Contributions-(Single-Example)">
<h2>SHAP-based Feature Contributions (Single Example)<a class="headerlink" href="#SHAP-based-Feature-Contributions-(Single-Example)" title="Permalink to this headline"></a></h2>
<p>For a model-agnostic method, we can use <strong>SHAP (SHapley Additive exPlanations)</strong>(<a class="reference external" href="https://github.com/slundberg/shap">https://github.com/slundberg/shap</a>; <a class="reference external" href="https://christophm.github.io/interpretable-ml-book/shap.html">https://christophm.github.io/interpretable-ml-book/shap.html</a>). SHAP uses game theoretic approach to explain the output of any machine learning model. Unlike tree-interpreter, it has the theoretical principle of being consistent such that if the marginal contribution of a feature changes, the SHAP value changes consistent with that.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">single_example</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">100</span><span class="p">]]</span>
<span class="n">explainer</span> <span class="o">=</span> <span class="n">skexplain</span><span class="o">.</span><span class="n">ExplainToolkit</span><span class="p">(</span><span class="n">estimators</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">=</span><span class="n">single_example</span><span class="p">,)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">local_contributions</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;shap&#39;</span><span class="p">,</span>
                                       <span class="n">shap_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;masker&#39;</span> <span class="p">:</span>
                                          <span class="n">shap</span><span class="o">.</span><span class="n">maskers</span><span class="o">.</span><span class="n">Partition</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">max_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">clustering</span><span class="o">=</span><span class="s2">&quot;correlation&quot;</span><span class="p">),</span>
                                             <span class="s1">&#39;algorithm&#39;</span> <span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">})</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">plot_contributions</span><span class="p">(</span>
                               <span class="n">contrib</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
                               <span class="n">display_feature_names</span><span class="o">=</span><span class="n">plotting_config</span><span class="o">.</span><span class="n">display_feature_names</span><span class="p">,</span>
                               <span class="n">display_units</span> <span class="o">=</span> <span class="n">plotting_config</span><span class="o">.</span><span class="n">display_units</span><span class="p">,</span>
                                <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Exact explainer: 2it [00:29, 29.98s/it]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_feature_contributions_14_1.png" src="../_images/notebooks_feature_contributions_14_1.png" />
</div>
</div>
</section>
<section id="SHAP-based-Feature-Contributions-(Performance-based)">
<h2>SHAP-based Feature Contributions (Performance-based)<a class="headerlink" href="#SHAP-based-Feature-Contributions-(Performance-based)" title="Permalink to this headline"></a></h2>
<p>We can also average SHAP values over several examples (such as similar performers).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">skexplain</span><span class="o">.</span><span class="n">ExplainToolkit</span><span class="p">(</span><span class="n">estimators</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">estimator_output</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">local_contributions</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;shap&#39;</span><span class="p">,</span>
                                       <span class="n">performance_based</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">n_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                       <span class="n">shap_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;masker&#39;</span> <span class="p">:</span>
                                      <span class="n">shap</span><span class="o">.</span><span class="n">maskers</span><span class="o">.</span><span class="n">Partition</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">max_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">clustering</span><span class="o">=</span><span class="s2">&quot;correlation&quot;</span><span class="p">),</span>
                                     <span class="s1">&#39;algorithm&#39;</span> <span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">}</span>
                                          <span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">plot_contributions</span><span class="p">(</span><span class="n">contrib</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
                            <span class="n">display_feature_names</span><span class="o">=</span><span class="n">plotting_config</span><span class="o">.</span><span class="n">display_feature_names</span><span class="p">,</span>
                            <span class="n">display_units</span> <span class="o">=</span> <span class="n">plotting_config</span><span class="o">.</span><span class="n">display_units</span><span class="p">,</span>
                                   <span class="n">n_columns</span><span class="o">=</span><span class="mi">2</span>
                        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Exact explainer: 6it [01:05, 13.04s/it]
Exact explainer: 6it [01:16, 15.23s/it]
Exact explainer: 6it [01:19, 15.84s/it]
Exact explainer: 6it [01:21, 16.37s/it]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_feature_contributions_16_1.png" src="../_images/notebooks_feature_contributions_16_1.png" />
</div>
</div>
<section id="LIME-based-Feature-Contributions">
<h3>LIME-based Feature Contributions<a class="headerlink" href="#LIME-based-Feature-Contributions" title="Permalink to this headline"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">single_example</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">100</span><span class="p">]]</span>
<span class="n">explainer</span> <span class="o">=</span> <span class="n">skexplain</span><span class="o">.</span><span class="n">ExplainToolkit</span><span class="p">(</span><span class="n">estimators</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">=</span><span class="n">single_example</span><span class="p">,)</span>

<span class="o">+</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">local_contributions</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span>
                                       <span class="n">lime_kws</span><span class="o">=</span><span class="n">lime_kws</span><span class="p">,)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">plot_contributions</span><span class="p">(</span>
                               <span class="n">contrib</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
                               <span class="n">display_feature_names</span><span class="o">=</span><span class="n">plotting_config</span><span class="o">.</span><span class="n">display_feature_names</span><span class="p">,</span>
                               <span class="n">display_units</span> <span class="o">=</span> <span class="n">plotting_config</span><span class="o">.</span><span class="n">display_units</span><span class="p">,</span>
                                <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1, 30) 0.4790962241291973
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_feature_contributions_18_1.png" src="../_images/notebooks_feature_contributions_18_1.png" />
</div>
</div>
</section>
<section id="Feature-Contributions-for-Regression-Problems">
<h3>Feature Contributions for Regression Problems<a class="headerlink" href="#Feature-Contributions-for-Regression-Problems" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_california_housing</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">fetch_california_housing</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature_names&#39;</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RandomForestRegressor()
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">single_example</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="mi">100</span><span class="p">]]</span>
<span class="n">explainer</span> <span class="o">=</span> <span class="n">skexplain</span><span class="o">.</span><span class="n">ExplainToolkit</span><span class="p">((</span><span class="s1">&#39;Random Forest&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span>
                                    <span class="n">X</span><span class="o">=</span><span class="n">single_example</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                                    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">local_contributions</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;shap&#39;</span><span class="p">,</span>
                                        <span class="n">performance_based</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">shap_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;masker&#39;</span> <span class="p">:</span>
                                             <span class="n">shap</span><span class="o">.</span><span class="n">maskers</span><span class="o">.</span><span class="n">Partition</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">max_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                                                    <span class="n">clustering</span><span class="o">=</span><span class="s2">&quot;correlation&quot;</span><span class="p">),</span>
                                             <span class="s1">&#39;algorithm&#39;</span> <span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">}</span>
                                          <span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">plot_contributions</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_feature_contributions_23_0.png" src="../_images/notebooks_feature_contributions_23_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../feature_attributions.html" class="btn btn-neutral float-left" title="Feature Attributions (SHAP, LIME, and TreeInterpreter)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../shap.html" class="btn btn-neutral float-right" title="SHAP" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Montgomery Flora; Shawn Handler.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>